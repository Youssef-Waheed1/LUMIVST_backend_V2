"""
batch_verify_dates.py
شغّل verify_ohlc لقائمة تواريخ وجمّع النتائج في ملف CSV
"""

import sys
import subprocess
from pathlib import Path
from datetime import datetime
import csv

# قائمة التواريخ (M/D/YYYY -> YYYY-MM-DD)
dates_str = """1/1/2025 1/2/2025 1/5/2025 1/6/2025 1/7/2025 1/8/2025 1/9/2025 1/12/2025 1/13/2025 1/14/2025 1/15/2025 1/16/2025 1/19/2025 1/20/2025 1/21/2025 1/22/2025 1/23/2025 1/26/2025 1/27/2025 1/28/2025 1/29/2025 1/30/2025 2/2/2025 2/3/2025 2/4/2025 2/5/2025 2/6/2025 2/9/2025 2/10/2025 2/11/2025 2/12/2025 2/13/2025 2/16/2025 2/17/2025 2/18/2025 2/19/2025 2/20/2025 2/24/2025 2/25/2025 2/26/2025 2/27/2025 3/2/2025 3/3/2025 3/4/2025 3/5/2025 3/6/2025 3/9/2025 3/10/2025 3/11/2025 3/12/2025 3/13/2025 3/16/2025 3/17/2025 3/18/2025 3/19/2025 3/20/2025 3/23/2025 3/24/2025 3/25/2025 3/26/2025 3/27/2025 4/3/2025 4/6/2025 4/7/2025 4/8/2025 4/9/2025 4/10/2025 4/13/2025 4/14/2025 4/15/2025 4/16/2025 4/17/2025 4/20/2025 4/21/2025 4/22/2025 4/23/2025 4/24/2025 4/27/2025 4/28/2025 4/29/2025 4/30/2025 5/1/2025 5/4/2025 5/5/2025 5/6/2025 5/7/2025 5/8/2025 5/11/2025 5/12/2025 5/13/2025 5/14/2025 5/15/2025 5/18/2025 5/19/2025 5/20/2025 5/21/2025 5/22/2025 5/25/2025 5/26/2025 5/27/2025 5/28/2025 5/29/2025 6/1/2025 6/2/2025 6/3/2025 6/4/2025 6/11/2025 6/12/2025 6/15/2025 6/16/2025 6/17/2025 6/18/2025 6/19/2025 6/22/2025 6/23/2025 6/24/2025 6/25/2025 6/26/2025 6/29/2025 6/30/2025 7/1/2025 7/2/2025 7/3/2025 7/6/2025 7/7/2025 7/8/2025 7/9/2025 7/10/2025 7/13/2025 7/14/2025 7/15/2025 7/16/2025 7/17/2025 7/20/2025 7/21/2025 7/22/2025 7/23/2025 7/24/2025 7/27/2025 7/28/2025 7/29/2025 7/30/2025 7/31/2025 8/3/2025 8/4/2025 8/5/2025 8/6/2025 8/7/2025 8/10/2025 8/11/2025 8/12/2025 8/13/2025 8/14/2025 8/17/2025 8/18/2025 8/19/2025 8/20/2025 8/21/2025 8/24/2025 8/25/2025 8/26/2025 8/27/2025 8/28/2025 8/31/2025 9/1/2025 9/2/2025 9/3/2025 9/4/2025 9/7/2025 9/8/2025 9/9/2025 9/10/2025 9/11/2025 9/14/2025 9/15/2025 9/16/2025 9/17/2025 9/18/2025 9/21/2025 9/22/2025 9/24/2025 9/25/2025 9/28/2025 9/29/2025 9/30/2025 10/1/2025 10/2/2025 10/5/2025 10/6/2025 10/7/2025 10/8/2025 10/9/2025 10/12/2025 10/13/2025 10/14/2025 10/15/2025 10/16/2025 10/19/2025 10/20/2025 10/21/2025 10/22/2025 10/23/2025 10/26/2025 10/27/2025 10/28/2025 10/29/2025 10/30/2025 11/2/2025 11/3/2025 11/4/2025 11/5/2025 11/6/2025 11/9/2025 11/10/2025 11/11/2025 11/12/2025 11/13/2025 11/16/2025 11/17/2025 11/18/2025 11/19/2025 11/20/2025 11/23/2025 11/24/2025 11/25/2025 11/26/2025 11/27/2025 11/30/2025 12/1/2025 12/2/2025 12/3/2025 12/4/2025 12/7/2025 12/8/2025 12/9/2025 12/10/2025 12/11/2025 12/14/2025 12/15/2025 12/16/2025 12/17/2025 12/18/2025 12/21/2025 12/22/2025 12/23/2025 12/24/2025 12/25/2025 12/28/2025 12/29/2025 12/30/2025 12/31/2025 1/1/2026 1/4/2026 1/5/2026 1/6/2026 1/7/2026 1/8/2026 1/11/2026 1/12/2026 1/13/2026 1/14/2026 1/15/2026 1/18/2026 1/19/2026 1/20/2026 1/21/2026 1/22/2026 1/25/2026 1/26/2026 1/27/2026 1/28/2026 1/29/2026 2/1/2026 2/2/2026 2/3/2026 2/4/2026 2/5/2026 2/8/2026 2/9/2026 2/10/2026 2/11/2026 2/12/2026"""

# تحويل التواريخ
dates = []
for date_str in dates_str.split():
    try:
        dt = datetime.strptime(date_str, '%m/%d/%Y')
        iso_date = dt.strftime('%Y-%m-%d')
        dates.append(iso_date)
    except Exception as e:
        print(f"Error parsing {date_str}: {e}")

print(f"إجمالي التواريخ: {len(dates)}")
print(f"من {dates[0]} إلى {dates[-1]}\n")

# تشغيل verify_ohlc لكل تاريخ
symbol = '1321'
results = []

for i, date_val in enumerate(dates, 1):
    print(f"[{i}/{len(dates)}] Processing {date_val}... ", end='', flush=True)
    try:
        cmd = [sys.executable, 'scripts/verify_ohlc.py', symbol, date_val]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
        
        if result.returncode == 0:
            output = result.stdout
            # Extract WEEKLY and MONTHLY lines
            weekly_line = None
            monthly_line = None
            for line in output.split('\n'):
                if 'WEEKLY (W-THU)' in line:
                    weekly_line = line
                if 'MONTHLY (M)' in line:
                    monthly_line = line
            
            results.append({
                'date': date_val,
                'status': 'OK',
                'weekly': weekly_line if weekly_line else 'N/A',
                'monthly': monthly_line if monthly_line else 'N/A'
            })
            print("✓")
        else:
            results.append({
                'date': date_val,
                'status': 'ERROR',
                'weekly': result.stderr[:50] if result.stderr else 'Unknown error',
                'monthly': ''
            })
            print("✗")
    except Exception as e:
        results.append({
            'date': date_val,
            'status': 'ERROR',
            'weekly': str(e),
            'monthly': ''
        })
        print(f"✗ {str(e)[:30]}")

# حفظ النتائج في CSV
output_file = 'batch_verify_results.csv'
with open(output_file, 'w', newline='', encoding='utf-8') as f:
    writer = csv.DictWriter(f, fieldnames=['date', 'status', 'weekly', 'monthly'])
    writer.writeheader()
    writer.writerows(results)

print(f"\n✓ تم حفظ النتائج في: {output_file}")
print(f"  تم معالجة {len([r for r in results if r['status']=='OK'])}/{len(dates)} تاريخ بنجاح")
